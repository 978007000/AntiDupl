using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using AntiDuplWPF.ObjectModel.ConditionMode;
using AntiDuplWPF.ViewModel;

namespace AntiDuplWPF.ObjectModel
{
    public class SelectCondition : PropertyChangedBase
    {
     
        private ConditionParametr _parametr;
        public ConditionParametr Parametr
        {
            get { return _parametr; }
            set
            {
                _parametr = value;
                RaisePropertyChangedEvent("Parametr");
            }
        }

        private IConditionMode _mode;
        public IConditionMode Mode
        {
            get { return _mode; }
            set
            {
                _mode = value;
                RaisePropertyChangedEvent("Mode");
            }
        }

        private double _valueDouble;
        public double ValueDouble
        {
            get { return _valueDouble; }
            set
            {
                _valueDouble = value;
                RaisePropertyChangedEvent("ValueDouble");
            }
        }

        private uint _valueUint;
        public uint ValueUint
        {
            get { return _valueUint; }
            set
            {
                _valueUint = value;
                RaisePropertyChangedEvent("ValueUint");
            }
        }

        //AntiDuplWPF.Core.CoreDll.TransformType _transformType;
        //public AntiDuplWPF.Core.CoreDll.TransformType TransformType
        //      {
        //          get { return _transformType; }
        //    set
        //    {
        //        _transformType = value;
        //        RaisePropertyChangedEvent("TransformType");
        //    }
        //}

        public bool IsSelect(DuplPairViewModel pair)
        {
            if (pair.Type != Core.CoreDll.ResultType.DuplImagePair)
                return false;

            double percent;
            double doubleDifference;
            uint difference;
            switch (Parametr)
            {
                case ConditionParametr.Difference:
                    return Mode.IsSelect(pair.Difference, ValueDouble);
                    break;
                //case ConditionParametr.Blockiness:
                //    break;
                case ConditionParametr.BlockinessDifference:
                    doubleDifference = Math.Abs(pair.FirstFile.Blockiness - pair.SecondFile.Blockiness);
                    return Mode.IsSelect(doubleDifference, ValueDouble);
                case ConditionParametr.BlockinessDifferenceInPercent:
                    doubleDifference = Math.Abs(pair.FirstFile.Blockiness - pair.SecondFile.Blockiness);
                    if (doubleDifference == 0)
                        return Mode.IsSelect(0.0, ValueDouble);
                    else
                    {
                        percent = Math.Min(pair.FirstFile.Blockiness, pair.SecondFile.Blockiness) * 100 / Math.Max(pair.FirstFile.Blockiness, pair.SecondFile.Blockiness);
                        return Mode.IsSelect(percent, ValueDouble);
                    }
                    break;
                //case ConditionParametr.Blurring:
                //    break;
                case ConditionParametr.BlurringDifference:
                    doubleDifference = Math.Abs(pair.FirstFile.Bluring - pair.SecondFile.Bluring);
                    return Mode.IsSelect(doubleDifference, ValueDouble);
                case ConditionParametr.BlurringDifferenceInPercent:
                    doubleDifference = Math.Abs(pair.FirstFile.Bluring - pair.SecondFile.Bluring);
                    if (doubleDifference == 0)
                        return Mode.IsSelect(0.0, ValueDouble);
                    else
                    {
                        percent = Math.Min(pair.FirstFile.Bluring, pair.SecondFile.Bluring) * 100 / Math.Max(pair.FirstFile.Bluring, pair.SecondFile.Bluring);
                        return Mode.IsSelect(percent, ValueDouble);
                    }
                    break;
                //case ConditionParametr.Resolution:
                //    break;
                case ConditionParametr.ResolutionDifference:
                    difference = Math.Max(pair.FirstFile.Height * pair.FirstFile.Width, pair.SecondFile.Height * pair.SecondFile.Width)
                        - Math.Min(pair.FirstFile.Height * pair.FirstFile.Width, pair.SecondFile.Height * pair.SecondFile.Width);
                    return Mode.IsSelect(difference, ValueUint);
                    break;
                //case ConditionParametr.ResolutionDifferenceInPercent:
                //    break;
                //case ConditionParametr.FileSize:
                //    break;
                case ConditionParametr.NoTransformType:
                    return pair.Transform == Core.CoreDll.TransformType.Turn_0;
                    break;
                //case ConditionParametr.SameDirectory:
                //    return pair.FirstFile.Directory == pair.SecondFile.Directory;
                //    break;
                case ConditionParametr.SameType:
                    return pair.FirstFile.Type == pair.SecondFile.Type;
                case ConditionParametr.DctHistogramPeaksDctHistogramPeaksDifference:
                    difference = Math.Max(pair.FirstFile.JpegPeaks, pair.SecondFile.JpegPeaks)
                        - Math.Min(pair.FirstFile.JpegPeaks, pair.SecondFile.JpegPeaks);
                    return Mode.IsSelect(difference, ValueUint);
                    break;
                default:
                    throw new ArgumentException("Неизвестный параметр");
            }
            return true;
        }
    }
}
